name: Issue Worksheet PDF

on:
  issues:
    types: [opened, edited, reopened]

  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number to rebuild PDF for"
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet-pdf:
    runs-on: ubuntu-latest

    steps:
      # 1. Pull the repo so we can store PDFs into it
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main   # change if your default branch is not main

      # 2. Build a TEMPORARY markdown file from the issue data
      #    (this file is NOT in the repo and will NOT be committed)
      - name: Build temporary worksheet markdown
        id: build_md
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");

            // Expand <details><summary>...</summary> ... </details>
            // into plain, always-visible markdown
            function expandDetails(html) {
              if (!html) return "";
              return html.replace(/<details>([\s\S]*?)<\/details>/gi, (match, inner) => {
                const summaryMatch = inner.match(/<summary>([\s\S]*?)<\/summary>/i);
                let summary = "";
                let rest = inner;

                if (summaryMatch) {
                  // Clean summary of any HTML tags
                  summary = summaryMatch[1]
                    .replace(/<\/?[^>]+>/g, "")
                    .trim();
                  // Everything after </summary> is the "body" content
                  rest = inner.slice(summaryMatch.index + summaryMatch[0].length);
                }

                // Strip the first <br> after summary if present
                rest = rest.replace(/^\s*<br\s*\/?>\s*/i, "");

                // Return expanded block as markdown
                return `\n\n**${summary || "Details"}**\n\n${rest.trim()}\n\n`;
              });
            }

            try {
              const owner = context.repo.owner;
              const repo = context.repo.repo;

              let issue;

              // Determine how the workflow was triggered
              if (context.payload.issue) {
                core.info("Using issue from event payload");
                issue = context.payload.issue;
              } else {
                const issueNumber = Number(context.payload.inputs["issue-number"]);
                if (!issueNumber) {
                  core.setFailed("No issue-number provided.");
                  return;
                }
                core.info(`Fetching issue #${issueNumber} via REST API`);
                const { data } = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: issueNumber
                });
                issue = data;
              }

              const n = issue.number;
              core.info(`Building worksheet markdown for issue #${n}`);

              // TEMP folder RELATIVE to /github/workspace
              const tmpDir = path.join("tmp_worksheets");
              fs.mkdirSync(tmpDir, { recursive: true });

              const mdFilename = `issue-${n}.md`;
              const mdPath = path.join(tmpDir, mdFilename);

              // Metadata
              const labels = (issue.labels || [])
                .map(l => (typeof l === "string" ? l : l.name))
                .join(", ") || "None";

              const assignees = (issue.assignees || [])
                .map(a => a.login)
                .join(", ") || "None";

              const rawBody = issue.body || "_No description provided._";
              const bodyText = expandDetails(rawBody);
              const updated = issue.updated_at || issue.created_at;

              // Markdown content for worksheet
              const mdLines = [
                `# Issue #${n}: ${issue.title}`,
                "",
                `**Repository:** \`${owner}/${repo}\``,
                `**URL:** ${issue.html_url}`,
                `**Author:** @${issue.user?.login || "unknown"}`,
                `**State:** \`${issue.state}\``,
                `**Labels:** ${labels}`,
                `**Assignees:** ${assignees}`,
                `**Created:** ${issue.created_at}`,
                `**Updated:** ${issue.updated_at}`,
                "",
                `**Worksheet version:** ${updated}`,
                "",
                "---",
                "",
                bodyText,
                ""
              ];

              const md = mdLines.join("\n");

              // Write TEMP file (not tracked by git)
              fs.writeFileSync(mdPath, md, "utf8");
              core.info(`Wrote temporary markdown to: ${mdPath}`);

              // Final PDF will live in repo at: worksheets/issue-<n>.pdf
              const pdfPath = path.join("worksheets", `issue-${n}.pdf`);

              core.setOutput("issue-number", String(n));
              core.setOutput("md-path", mdPath);   // relative path
              core.setOutput("pdf-path", pdfPath);
            } catch (err) {
              core.error(`Error while building markdown: ${err}`);
              core.setFailed(err.message || String(err));
            }

      # 3. Convert the temporary Markdown â†’ PDF into the worksheets folder
      #    using the Marketplace Action: BaileyJM02/markdown-to-pdf
      - name: Convert worksheet markdown to PDF
        uses: BaileyJM02/markdown-to-pdf@v1
        with:
          # Convert all .md files in tmp_worksheets
          input_dir: tmp_worksheets
          # PDF output folder INSIDE the repo
          output_dir: worksheets

      # 4. Commit ONLY the PDFs back to main
      - name: Commit worksheet PDF
        run: |
          mkdir -p worksheets

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add only PDFs (no markdown)
          git add worksheets/*.pdf 2>/dev/null || echo "No PDFs to add"

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update worksheet PDF for issue #${{ steps.build_md.outputs.issue-number }}"
            git push
          fi

      # 5. Comment on the issue with a PDF link
      - name: Comment PDF link on issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.build_md.outputs.issue-number }}
          PDF_PATH: ${{ steps.build_md.outputs.pdf-path }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const pdfPathRaw = process.env.PDF_PATH;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";  // change if your default branch is not main

            const pdfPath = pdfPathRaw.replace(/^\.?\/?/, "");
            const url = `https://github.com/${owner}/${repo}/blob/${branch}/${pdfPath}?raw=1`;

            const bodyLines = [
              "ðŸ“„ **Your worksheet PDF is ready!**",
              "",
              `[Click here to download the PDF](${url})`,
              "",
              "_This PDF updates automatically whenever this issue is edited._"
            ];

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: bodyLines.join("\n"),
            });
