name: Issue Worksheet PDF

on:
  issues:
    types: [opened, edited, reopened]

  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number to rebuild PDF for"
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet-pdf:
    runs-on: ubuntu-latest

    steps:
      # 1. Pull the repo so we can store PDFs into it
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main   # change if your default branch is not main

      # 2. Build a TEMP markdown file from the issue data
      - name: Build temporary worksheet markdown
        id: build_md
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");

            // Expand <details><summary>...</summary>content</details>
            // into visible markdown sections.
            function expandDetails(html) {
              if (!html) return "";
              let out = html;

              out = out.replace(/<details[^>]*>([\s\S]*?)<\/details>/gi, (full, inner) => {
                const summaryMatch = inner.match(/<summary[^>]*>([\s\S]*?)<\/summary>/i);
                let summaryText = "";
                let rest = inner;

                if (summaryMatch) {
                  // Grab inner summary text and strip tags
                  summaryText = summaryMatch[1]
                    .replace(/<\/?[^>]+>/g, "")
                    .replace(/\s+/g, " ")
                    .trim();
                  // Everything after </summary> is the "body"
                  rest = inner.slice(summaryMatch.index + summaryMatch[0].length);
                }

                // Remove leading <br> if present
                rest = rest.replace(/^\s*<br\s*\/?>/i, "");

                // Wrap the expanded block in separators for readability
                return [
                  "",
                  "---",
                  summaryText ? `### ${summaryText}` : "",
                  "",
                  rest.trim(),
                  "",
                  "---",
                  ""
                ].join("\n");
              });

              return out;
            }

            try {
              const owner = context.repo.owner;
              const repo = context.repo.repo;

              let issue;

              // Determine how the workflow was triggered
              if (context.payload.issue) {
                // From an issue event (opened / edited / reopened)
                core.info("Using issue from event payload");
                issue = context.payload.issue;
              } else {
                // From workflow_dispatch
                const issueNumber = Number(context.payload.inputs["issue-number"]);
                if (!issueNumber) {
                  core.setFailed("No issue-number provided.");
                  return;
                }
                core.info(`Fetching issue #${issueNumber} via REST API`);
                const { data } = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: issueNumber
                });
                issue = data;
              }

              const n = issue.number;
              const updatedAt = new Date(
                issue.updated_at || issue.created_at || Date.now()
              ).toISOString();

              core.info(`Building worksheet markdown for issue #${n}`);

              // TEMP folder RELATIVE to /github/workspace
              const tmpDir = path.join("tmp_worksheets");
              fs.mkdirSync(tmpDir, { recursive: true });

              const mdFilename = `issue-${n}.md`;
              const mdPath = path.join(tmpDir, mdFilename);

              // Original issue body (markdown + HTML)
              const bodyRaw = issue.body || "_No description provided._";
              const bodyExpanded = expandDetails(bodyRaw);

              // Build markdown content for worksheet
              // Only extras: title + version line
              const mdLines = [
                `# ${issue.title || "Untitled issue"}`,
                "",
                `_Issue #${n} Â· Version generated from GitHub on ${updatedAt}_`,
                "",
                "---",
                "",
                bodyExpanded,
                ""
              ];

              const md = mdLines.join("\n");

              // Write TEMP file (not tracked by git)
              fs.writeFileSync(mdPath, md, "utf8");
              core.info(`Wrote temporary markdown to: ${mdPath}`);

              // Final PDF will live in repo at: worksheets/issue-<n>.pdf
              const pdfPath = path.join("worksheets", `issue-${n}.pdf`);

              core.setOutput("issue-number", String(n));
              core.setOutput("md-path", mdPath);   // relative path
              core.setOutput("pdf-path", pdfPath);
            } catch (err) {
              core.error(`Error while building markdown: ${err}`);
              core.setFailed(err.message || String(err));
            }

      # 3. Convert the temporary Markdown â†’ PDF into the worksheets folder
      - name: Convert markdown to PDF
        uses: BaileyJM02/markdown-to-pdf@v1.2.0
        with:
          input_path: ${{ steps.build_md.outputs.md-path }}
          output_dir: worksheets
          build_html: false
          build_pdf: true

      # 4. Commit ONLY the PDFs back to main
      - name: Commit worksheet PDF
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add only PDFs
          git add worksheets/*.pdf 2>/dev/null || echo "No PDFs to add"

          if git diff --cached --quiet; then
            echo "No changes to commit.";
          else
            git commit -m "Update worksheet PDF for issue #${{ steps.build_md.outputs.issue-number }}"
            git push
          fi

      # 5. Comment on the issue with a PDF link
      - name: Comment PDF link on issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.build_md.outputs.issue-number }}
          PDF_PATH: ${{ steps.build_md.outputs.pdf-path }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const pdfPathRaw = process.env.PDF_PATH;

            if (!issueNumber) {
              core.info("No issue number available; skipping comment.");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";  // change if your default branch is not main

            const pdfPath = pdfPathRaw.replace(/^\.?\/?/, "");
            const url = `https://github.com/${owner}/${repo}/blob/${branch}/${pdfPath}?raw=1`;

            const bodyLines = [
              "ðŸ“„ **Your worksheet PDF is ready!**",
              "",
              `[Click here to download the PDF](${url})`,
              "",
              "_This PDF updates automatically whenever this issue is edited._"
            ];

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: bodyLines.join("\n"),
            });
