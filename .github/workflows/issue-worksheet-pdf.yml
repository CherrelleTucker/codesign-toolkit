name: Issue Worksheet PDF

on:
  issues:
    types: [opened, edited, reopened]

  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number to rebuild PDF for"
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet-pdf:
    runs-on: ubuntu-latest

    steps:
      # 1. Pull the repo so we can store PDFs into it
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main   # change if your default branch is not main

      # 2. Build a TEMPORARY markdown file from the issue data
      #    (this file is NOT in the repo and will NOT be committed)
      - name: Build temporary worksheet markdown
        id: build_md
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Helper: expand <details><summary> blocks into normal markdown
            function expandDetailsBlocks(md) {
              if (!md) return md;
              return md.replace(/<details>([\s\S]*?)<\/details>/gi, (match, inner) => {
                // Find the first <summary>...</summary>
                const summaryMatch = inner.match(/<summary>([\s\S]*?)<\/summary>/i);
                let summaryText = "Details";
                let rest = inner;

                if (summaryMatch) {
                  // Extract summary inner HTML, strip tags
                  summaryText = summaryMatch[1]
                    .replace(/<\/?[^>]+>/g, "")
                    .trim() || "Details";
                  // Everything after </summary> is the real content
                  rest = inner.slice(summaryMatch[0].length).trim();
                }

                // Return as a markdown heading + content
                return `\n\n### ${summaryText}\n\n${rest}\n\n`;
              });
            }

            let issue;

            // Determine how the workflow was triggered
            if (context.payload.issue) {
              issue = context.payload.issue;
            } else {
              const issueNumber = Number(context.payload.inputs["issue-number"]);
              if (!issueNumber) {
                core.setFailed("No issue-number provided.");
                return;
              }
              const { data } = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber
              });
              issue = data;
            }

            const n = issue.number;

            // TEMP folder RELATIVE to /github/workspace
            const tmpDir = path.join("tmp_worksheets");
            fs.mkdirSync(tmpDir, { recursive: true });

            const mdFilename = `issue-${n}.md`;
            const mdPath = path.join(tmpDir, mdFilename);

            // Build metadata
            const labels = (issue.labels || [])
              .map(l => (typeof l === "string" ? l : l.name))
              .join(", ") || "None";

            const assignees = (issue.assignees || [])
              .map(a => a.login)
              .join(", ") || "None";

            // Original issue body (markdown + HTML)
            let bodyText = issue.body || "_No description provided._";

            // Expand any <details><summary> blocks before conversion
            bodyText = expandDetailsBlocks(bodyText);

            // Build markdown content for worksheet
            const md = [
              `# Issue #${n}: ${issue.title}`,
              "",
              `**Repository:** \`${owner}/${repo}\``,
              `**URL:** ${issue.html_url}`,
              `**Author:** @${issue.user?.login || "unknown"}`,
              `**State:** \`${issue.state}\``,
              `**Labels:** ${labels}`,
              `**Assignees:** ${assignees}`,
              `**Created:** ${issue.created_at}`,
              `**Updated:** ${issue.updated_at}`,
              "",
              "---",
              "",
              bodyText,
              ""
            ].join("\n");

            // Write TEMP file (not t
