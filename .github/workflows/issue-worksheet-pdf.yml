name: Issue Worksheet PDF

on:
  issues:
    types: [opened, edited, reopened]

  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number to rebuild PDF for"
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet-pdf:
    runs-on: ubuntu-latest

    steps:
      # 1. Pull the repo so we can write worksheets into it
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. Build the worksheet markdown file from issue data
      - name: Build worksheet markdown
        id: build_md
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let issue;

            // Determine how the workflow was triggered
            if (context.payload.issue) {
              issue = context.payload.issue;
            } else {
              const issueNumber = Number(context.payload.inputs["issue-number"]);
              if (!issueNumber) {
                core.setFailed("No issue-number provided.");
                return;
              }
              const { data } = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber
              });
              issue = data;
            }

            const n = issue.number;

            // Prepare folder
            const dir = path.join("codesign-toolkit", "worksheets");
            fs.mkdirSync(dir, { recursive: true });

            const mdFilename = `issue-${n}.md`;
            const mdPath = path.join(dir, mdFilename);

            // Build metadata
            const labels = (issue.labels || [])
              .map(l => (typeof l === "string" ? l : l.name))
              .join(", ") || "None";

            const assignees = (issue.assignees || [])
              .map(a => a.login)
              .join(", ") || "None";

            const bodyText = issue.body || "_No description provided._";

            // Build markdown content for worksheet
            const md = [
              `# Issue #${n}: ${issue.title}`,
              "",
              `**Repository:** \`${owner}/${repo}\``,
              `**URL:** ${issue.html_url}`,
              `**Author:** @${issue.user?.login || "unknown"}`,
              `**State:** \`${issue.state}\``,
              `**Labels:** ${labels}`,
              `**Assignees:** ${assignees}`,
              `**Created:** ${issue.created_at}`,
              `**Updated:** ${issue.updated_at}`,
              "",
              "---",
              "",
              bodyText,
              ""
            ].join("\n");

            // Write file
            fs.writeFileSync(mdPath, md, "utf8");

            // Outputs for later steps
            core.setOutput("issue-number", String(n));
            core.setOutput("md-path", mdPath);
            core.setOutput("pdf-path", mdPath.replace(/\.md$/, ".pdf"));

      # 3. Convert Markdown â†’ PDF
      - name: Convert worksheet to PDF
        uses: baileyjm02/markdown-to-pdf@v1
        with:
          input_path: ${{ steps.build_md.outputs.md-path }}
          output_dir: codesign-toolkit/worksheets
          build_html: false
          build_pdf: true

      # 4. Commit the updated markdown + PDF back to main
      - name: Commit worksheet & PDF
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add codesign-toolkit/worksheets

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update worksheet PDF for issue #${{ steps.build_md.outputs.issue-number }}"
            git push
          fi

      # 5. Comment on the issue with a PDF link
      - name: Comment PDF link on issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.build_md.outputs.issue-number }}
          PDF_PATH: ${{ steps.build_md.outputs.pdf-path }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const pdfPath = process.env.PDF_PATH.replace(/^\.?\/?/, "");
            const branch = "main";

            const url = `https://github.com/${owner}/${repo}/blob/${branch}/${pdfPath}?raw=1`;

            const body = [
              "ðŸ“„ **Your worksheet PDF is ready!**",
              "",
              `[Click here to download the PDF](${url})`,
              "",
              "_This PDF updates automatically whenever this issue is edited._"
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body
            });
