name: Issue Worksheet PDF

on:
  issues:
    types: [opened, edited, reopened]

  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number to rebuild PDF for"
        required: true
        type: number

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet-pdf:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out repo so we can write into /worksheets and commit
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. Build/overwrite worksheets/issue-<n>.md from issue + expand <details>
      - name: Build worksheet markdown from issue
        id: build_md
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let issue;

            // Figure out which issue we're working on
            if (context.payload.issue) {
              core.info("Using issue from event payload");
              issue = context.payload.issue;
            } else {
              const issueNumber = Number(context.payload.inputs["issue-number"]);
              if (!issueNumber) {
                core.setFailed("No issue-number provided.");
                return;
              }
              core.info(`Fetching issue #${issueNumber} via REST API`);
              const { data } = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber,
              });
              issue = data;
            }

            const n = issue.number;
            core.info(`Building worksheet markdown for issue #${n}`);

            // Helper to expand <details> blocks into plain markdown sections
            function expandDetails(body) {
              if (!body) return "";

              let output = body;

              // Match <details ...> ... </details> with any inner content
              const detailsRegex = /<details[^>]*>([\s\S]*?)<\/details>/gi;

              output = output.replace(detailsRegex, (fullMatch, inner) => {
                // Grab the <summary> ... </summary> part
                const summaryRegex = /<summary[^>]*>([\s\S]*?)<\/summary>/i;
                const summaryMatch = inner.match(summaryRegex);

                if (!summaryMatch) {
                  // No summary? Just return inner content as-is.
                  return inner;
                }

                const summaryHtml = summaryMatch[1] || "";
                // Strip HTML tags from summary text (keep emoji/text)
                const summaryText = summaryHtml.replace(/<\/?[^>]+>/g, "").trim() || "Section";

                // The rest of the content (after summary)
                const rest = inner.replace(summaryRegex, "").trim();

                // Turn into a visible markdown section
                let result = `\n\n---\n\n### ${summaryText}\n\n`;
                if (rest) {
                  result += rest + "\n\n";
                }
                return result;
              });

              return output;
            }

            const expandedBody = expandDetails(issue.body || "_No description provided._");

            const labels = (issue.labels || [])
              .map(l => (typeof l === "string" ? l : l.name))
              .join(", ") || "None";

            const assignees = (issue.assignees || [])
              .map(a => a.login)
              .join(", ") || "None";

            const created = issue.created_at || "";
            const updated = issue.updated_at || "";
            const now = new Date().toISOString();

            // Ensure worksheets directory exists
            const worksheetsDir = path.join(process.env.GITHUB_WORKSPACE, "worksheets");
            fs.mkdirSync(worksheetsDir, { recursive: true });

            const mdFilename = `issue-${n}.md`;
            const mdPath = path.join(worksheetsDir, mdFilename);

            const mdLines = [
              `# Issue #${n}: ${issue.title}`,
              "",
              `**Repository:** \`${owner}/${repo}\``,
              `**URL:** ${issue.html_url}`,
              `**Author:** @${issue.user?.login || "unknown"}`,
              "",
              `**State:** \`${issue.state}\``,
              `**Labels:** ${labels}`,
              `**Assignees:** ${assignees}`,
              "",
              `**Created:** ${created}`,
              `**Last Updated in GitHub:** ${updated}`,
              `**Worksheet Version:** ${now}`,
              "",
              "---",
              "",
              expandedBody,
              ""
            ];

            fs.writeFileSync(mdPath, mdLines.join("\n"), "utf8");
            core.info(`Wrote worksheet markdown to: ${mdPath}`);

            // Outputs are RELATIVE to repo root for later steps
            core.setOutput("issue-number", String(n));
            core.setOutput("md-rel-path", `worksheets/${mdFilename}`);
            core.setOutput("pdf-rel-path", `worksheets/issue-${n}.pdf`);

      # 3. Convert markdown to PDF using md-to-pdf directly
      - name: Install md-to-pdf
        run: npm install -g md-to-pdf

      - name: Convert worksheet markdown to PDF
        run: |
          cd worksheets
          md-to-pdf "issue-${{ steps.build_md.outputs.issue-number }}.md" \
            --launch-options '{"args": ["--no-sandbox", "--disable-setuid-sandbox"]}'
          
          # md-to-pdf creates issue-N.md.pdf, rename to issue-N.pdf
          if [ -f "issue-${{ steps.build_md.outputs.issue-number }}.md.pdf" ]; then
            mv "issue-${{ steps.build_md.outputs.issue-number }}.md.pdf" \
               "issue-${{ steps.build_md.outputs.issue-number }}.pdf"
            echo "‚úÖ PDF renamed successfully"
          else
            echo "‚ùå PDF not found at expected location"
            ls -la
            exit 1
          fi

      # 4. Commit the .md and .pdf back to main
      - name: Commit worksheet md & PDF
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "worksheets/issue-${{ steps.build_md.outputs.issue-number }}.md" \
                  "worksheets/issue-${{ steps.build_md.outputs.issue-number }}.pdf"

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update worksheet for issue #${{ steps.build_md.outputs.issue-number }}"
            git push
          fi

      # 5. Comment the PDF link on the issue
      - name: Comment PDF link on issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.build_md.outputs.issue-number }}
          PDF_REL: ${{ steps.build_md.outputs.pdf-rel-path }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const pdfRel = process.env.PDF_REL;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";

            const url = `https://github.com/${owner}/${repo}/raw/${branch}/${pdfRel}`;

            const bodyLines = [
              "üìÑ **Your worksheet PDF is ready!**",
              "",
              `[Click here to download the PDF](${url})`,
              "",
              "_This PDF updates automatically whenever this issue is edited._"
            ];

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: bodyLines.join("\n"),
            });
