name: Issue Reopened Worksheet

on:
  issues:
    types: [reopened]

permissions:
  contents: write
  issues: write

jobs:
  on-reopened:
    runs-on: ubuntu-latest

    steps:
      - name: Debug event
        run: |
          echo "Event name: $GITHUB_EVENT_NAME"
          echo "Action: ${{ github.event.action }}"
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue title:  ${{ github.event.issue.title }}"
          echo "State:        ${{ github.event.issue.state }}"

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Write worksheet markdown
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          mkdir -p worksheets
          FILE="worksheets/test-${ISSUE_NUMBER}.md"

          {
            echo "# Issue ${ISSUE_NUMBER}: ${ISSUE_TITLE}"
            echo ""
            echo "## Body"
            if [ -n "$ISSUE_BODY" ]; then
              printf '%s\n' "$ISSUE_BODY"
            else
              echo "(No body on this issue.)"
            fi
          } > "$FILE"

          echo "Created $FILE"

      - name: Commit worksheet
        run: |
          FILE="worksheets/test-${{ github.event.issue.number }}.md"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$FILE"
          git commit -m "Add worksheet for reopened issue #${{ github.event.issue.number }}" || echo "No changes to commit"
          git push || echo "No changes pushed"

      - name: Comment on issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `♻️ Issue was reopened. Worksheet updated at \`worksheets/test-${issueNumber}.md\`.`
            });
