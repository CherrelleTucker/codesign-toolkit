name: Issue Reopened Worksheet

on:
  issues:
    types:
      - reopened
  workflow_dispatch:
    inputs:
      issue-number:
        description: 'Issue number to process when run manually (optional)'
        required: false
        type: number

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Debug event
        run: |
          echo "Event name: $GITHUB_EVENT_NAME"
          echo "Action: ${{ github.event.action }}"
          echo "Issue number (from context): ${{ github.event.issue.number }}"
          echo "Issue title (from context): ${{ github.event.issue.title }}"
          echo "Manual input issue-number: ${{ github.event.inputs.issue-number }}"
          echo "Raw event payload:"
          cat "$GITHUB_EVENT_PATH"

      # === Pull issue metadata for reopened issues ===
      - name: Set vars from reopened issue
        if: github.event_name == 'issues' && github.event.action == 'reopened'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "Setting env vars from reopened issue..."
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "ISSUE_TITLE=$ISSUE_TITLE" >> $GITHUB_ENV
          {
            echo 'ISSUE_BODY<<EOF'
            printf '%s\n' "$ISSUE_BODY"
            echo 'EOF'
          } >> $GITHUB_ENV

      # === Manual button path (optional) ===
      - name: Set vars from manual input
        if: github.event_name == 'workflow_dispatch'
        env:
          INPUT_ISSUE_NUMBER: ${{ github.event.inputs.issue-number }}
        run: |
          echo "Setting env vars from manual run..."
          if [ -n "$INPUT_ISSUE_NUMBER" ]; then
            ISSUE_NUMBER="$INPUT_ISSUE_NUMBER"
            ISSUE_TITLE="Manual run for issue #$INPUT_ISSUE_NUMBER"
            ISSUE_BODY="Triggered via workflow_dispatch for issue #$INPUT_ISSUE_NUMBER."
          else
            ISSUE_NUMBER=""
            ISSUE_TITLE="Manual run (no issue)"
            ISSUE_BODY="Triggered via workflow_dispatch with no specific issue number."
          fi

          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "ISSUE_TITLE=$ISSUE_TITLE" >> $GITHUB_ENV
          {
            echo 'ISSUE_BODY<<EOF'
            printf '%s\n' "$ISSUE_BODY"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Show resolved env
        run: |
          echo "ISSUE_NUMBER=$ISSUE_NUMBER"
          echo "ISSUE_TITLE=$ISSUE_TITLE"
          echo "ISSUE_BODY (first 200 chars):"
          printf '%s\n' "$ISSUE_BODY" | head -c 200 || true
        env:
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
          ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
          ISSUE_BODY: ${{ env.ISSUE_BODY }}

      - name: Write worksheet markdown
        run: |
          mkdir -p worksheets
          SUFFIX="${ISSUE_NUMBER:-manual}"
          FILE="worksheets/test-${SUFFIX}.md"

          {
            echo "# Issue ${ISSUE_NUMBER:-manual}: ${ISSUE_TITLE:-Manual run}"
            echo ""
            echo "## Body"
            if [ -n "$ISSUE_BODY" ]; then
              printf '%s\n' "$ISSUE_BODY"
            else
              echo "(No issue body available for this run.)"
            fi
          } > "$FILE"

          echo "Created $FILE"
        env:
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
          ISSUE_TITLE: ${{ env.ISSUE_TITLE }}
          ISSUE_BODY: ${{ env.ISSUE_BODY }}

      - name: Commit worksheet (only if we have an issue number)
        if: env.ISSUE_NUMBER != '' && github.event_name != 'workflow_dispatch'
        run: |
          FILE="worksheets/test-${ISSUE_NUMBER}.md"
          echo "Preparing to commit $FILE"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$FILE"
          git commit -m "Add worksheet for reopened issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push || echo "No changes pushed"
        env:
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}

      - name: Comment on issue (only for real reopened issues)
        if: env.ISSUE_NUMBER != '' && github.event_name == 'issues' && github.event.action == 'reopened'
        uses: actions/github-script@v6
        env:
          ISSUE_NUMBER: ${{ env.ISSUE_NUMBER }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const { owner, repo } = context.repo;

            core.info(`Commenting on reopened issue #${issueNumber} in ${owner}/${repo}`);

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `♻️ Issue was reopened. Worksheet updated at \`worksheets/test-${issueNumber}.md\`.`
            });
