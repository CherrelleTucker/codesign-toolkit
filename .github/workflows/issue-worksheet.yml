name: Generate Issue Worksheet

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: write      # commit the worksheet file
  issues: write        # add label + comment

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Extract issue metadata from event
        run: |
          echo "Extracting issue metadata from $GITHUB_EVENT_PATH"
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_URL=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")
          ISSUE_LABELS=$(jq -r '[.issue.labels[].name] | join(", ")' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")

          # Save into environment for later steps
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> "$GITHUB_ENV"
          echo "ISSUE_TITLE=$ISSUE_TITLE" >> "$GITHUB_ENV"
          echo "ISSUE_URL=$ISSUE_URL" >> "$GITHUB_ENV"
          echo "ISSUE_LABELS=$ISSUE_LABELS" >> "$GITHUB_ENV"

          # Save body to a file (can be multi-line)
          printf "%s\n" "$ISSUE_BODY" > issue_body.txt

      - name: Ensure worksheets folder exists
        run: mkdir -p worksheets

      - name: Generate worksheet Markdown file
        run: |
          ISSUE_FILE="worksheets/issue-${ISSUE_NUMBER}.md"

          echo "Writing worksheet to $ISSUE_FILE"

          # Start fresh
          cat > "$ISSUE_FILE" <<EOF
# ðŸ“ Issue Worksheet for #${ISSUE_NUMBER}

**Title:** ${ISSUE_TITLE}  
**URL:** ${ISSUE_URL}  
**Labels:** ${ISSUE_LABELS}

---

## 1. Issue Snapshot

- **Issue Number:** #${ISSUE_NUMBER}
- **Title:** ${ISSUE_TITLE}
- **URL:** ${ISSUE_URL}
- **Labels:** ${ISSUE_LABELS}

---

## 2. Original Description (reference)

(Autofilled from the issue body. Use sections below for your working notes.)

-------------------- ORIGINAL ISSUE BODY --------------------

EOF

          # Append the raw issue body
          cat issue_body.txt >> "$ISSUE_FILE"

          cat >> "$ISSUE_FILE" <<'EOF'

-------------------- END ORIGINAL ISSUE BODY --------------------

## 3. Problem / Need Statement

> In your own words, summarize the core problem or need this issue represents.

- What is the main challenge?
- Who is impacted?
- Why does this matter now?

**Summary notes:**

---

## 4. Current Workflow / Context

> Map the current workflow or situation *before* any Solution Product changes it.

- What are the current steps?
- Who touches this at each step?
- Where are the bottlenecks, pain points, or risks?

**Notes:**

---

## 5. Desired Outcome / Success Criteria

> What does â€œsuccessâ€ look like from the stakeholder / user perspective?

- What will be easier, faster, or more accurate?
- How would you explain the improvement to a non-technical stakeholder?

**Success looks like:**

---

## 6. Assumptions & Open Questions

- **Assumptions:**
  - [ ] 
  - [ ] 

- **Open Questions:**
  - [ ] 
  - [ ] 

---

## 7. Next Actions

> Concrete, small next steps from this worksheet.

- [ ] 
- [ ] 
- [ ] 

EOF

      - name: Commit worksheet to repository
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add worksheets/
            git commit -m "chore: add/update worksheet for issue #${ISSUE_NUMBER}"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Add 'worksheet-generated' label
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: worksheet-generated

      - name: Comment with worksheet link
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          comment-identifier: worksheet-link
          body: |
            ðŸ“„ **Your worksheet has been generated for this issue.**

            You can view or print it here:

            https://github.com/${{ github.repository }}/blob/main/worksheets/issue-${{ github.event.issue.number }}.md

            This file will auto-update whenever the issue is edited or reopened.
