name: Generate Printable Worksheet

on:
  issues:
    types: [opened, edited, reopened]
    workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Ensure jq is installed
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          jq --version

      - name: Extract issue data
        run: |
          echo "Reading event payload from $GITHUB_EVENT_PATH"
          cat "$GITHUB_EVENT_PATH"

          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_URL=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")

          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> "$GITHUB_ENV"
          echo "ISSUE_TITLE=$ISSUE_TITLE" >> "$GITHUB_ENV"
          echo "ISSUE_URL=$ISSUE_URL" >> "$GITHUB_ENV"

          printf "%s\n" "$ISSUE_BODY" > issue_body.txt

      - name: Ensure worksheets directory exists
        run: mkdir -p worksheets

      - name: Generate worksheet file
        run: |
          echo "ISSUE_NUMBER=$ISSUE_NUMBER"
          echo "ISSUE_TITLE=$ISSUE_TITLE"
          echo "ISSUE_URL=$ISSUE_URL"

          FILE_PATH="worksheets/issue-${ISSUE_NUMBER}.md"

          {
            echo "# ${ISSUE_TITLE}";
            echo;
            echo "Printable worksheet generated from Issue #${ISSUE_NUMBER}";
            echo "Source: ${ISSUE_URL}";
            echo;
            echo "---";
            echo;
            cat issue_body.txt;
          } > "$FILE_PATH"

          echo "Wrote worksheet to $FILE_PATH"
          cat "$FILE_PATH"

      - name: Commit worksheet file
        run: |
          echo "Git status before committing:"
          git status

          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add worksheets/
            git commit -m "Generate/update worksheet for issue #${ISSUE_NUMBER}" || {
              echo "Commit failed, but continuing."
              exit 0
            }
            git push || {
              echo "Push failed (branch may be protected), but continuing."
              exit 0
            }
          else
            echo "No changes to commit."
          fi

      - name: Comment with worksheet link
        uses: peter-evans/create-or-update-comment@v4
        continue-on-error: true
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ðŸ“„ **Your printable worksheet is ready.**

            View or print it here:

            https://github.com/${{ github.repository }}/blob/main/worksheets/issue-${{ github.event.issue.number }}.md

            This worksheet will automatically update whenever this issue is edited or reopened.
