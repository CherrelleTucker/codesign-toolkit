name: Generate Printable Worksheet

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Extract issue data
        run: |
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_URL=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")

          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> "$GITHUB_ENV"
          echo "ISSUE_TITLE=$ISSUE_TITLE" >> "$GITHUB_ENV"
          echo "ISSUE_URL=$ISSUE_URL" >> "$GITHUB_ENV"

          printf "%s\n" "$ISSUE_BODY" > issue_body.txt

      - name: Ensure worksheets directory exists
        run: mkdir -p worksheets

      - name: Generate worksheet file
        run: |
          FILE_PATH="worksheets/issue-${ISSUE_NUMBER}.md"

          {
            echo "# ${ISSUE_TITLE}";
            echo;
            echo "Printable worksheet generated from Issue #${ISSUE_NUMBER}";
            echo "Source: ${ISSUE_URL}";
            echo;
            echo "---";
            echo;
            cat issue_body.txt;
          } > "$FILE_PATH"

      - name: Commit worksheet file
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add worksheets/
            git commit -m "Generate/update worksheet for issue #${ISSUE_NUMBER}"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Comment with worksheet link
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ðŸ“„ **Your printable worksheet is ready.**

            View or print it here:

            https://github.com/${{ github.repository }}/blob/main/worksheets/issue-${{ github.event.issue.number }}.md

            This worksheet will automatically update whenever this issue is edited or reopened.
