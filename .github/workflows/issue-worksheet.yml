name: Issue Worksheet

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Generate worksheet file
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -e
          echo "Issue number: ${ISSUE_NUMBER}"
          echo "Issue title: ${ISSUE_TITLE}"
          echo "Issue URL: ${ISSUE_URL}"

          mkdir -p worksheets
          FILE_PATH="worksheets/issue-${ISSUE_NUMBER}.md"

          {
            echo "# ${ISSUE_TITLE}"
            echo
            echo "Printable worksheet generated from Issue #${ISSUE_NUMBER}"
            echo "Source: ${ISSUE_URL}"
            echo
            echo "---"
            echo
            printf "%s\n" "${ISSUE_BODY}"
          } > "$FILE_PATH"

          echo "Created worksheet file at: $FILE_PATH"
          echo "=== File preview ==="
          cat "$FILE_PATH"

      - name: Commit worksheet file
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -e
          echo "Git status before commit:"
          git status

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add worksheets/

          # If nothing actually changed, skip commit/push
          if git diff --cached --quiet; then
            echo "No changes to commit (worksheet already up to date)."
            exit 0
          fi

          git commit -m "Generate/update worksheet for issue #${ISSUE_NUMBER}"
          echo "Committed worksheet."

          echo "Pushing to ${DEFAULT_BRANCH}..."
          git push origin "HEAD:${DEFAULT_BRANCH}"

      - name: Comment with worksheet link
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.payload.repository.default_branch;
            const url = `https://github.com/${owner}/${repo}/blob/${branch}/worksheets/issue-${issueNumber}.md`;

            const body = [
              "ðŸ“„ **Your printable worksheet is ready.**",
              "",
              "View or print it here:",
              "",
              url,
              "",
              "_This worksheet will automatically update when the issue is edited or reopened._"
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body,
            });
