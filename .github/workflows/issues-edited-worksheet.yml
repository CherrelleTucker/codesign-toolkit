name: Issue Edited Worksheet

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Build printable worksheet markdown
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
          const issue = event.issue || {};
          const repoFull = process.env.GITHUB_REPOSITORY || 'unknown/repo';

          const listText = (items, key) => {
            if (!Array.isArray(items) || items.length === 0) return 'None';
            const values = items
              .map(item => (key ? item?.[key] : item))
              .map(val => (typeof val === 'string' ? val.trim() : ''))
              .filter(Boolean);
            return values.length ? values.join(', ') : 'None';
          };

          const labels = listText(issue.labels, 'name');
          const assignees = listText(issue.assignees, 'login');
          const body = (issue.body && issue.body.trim()) ? issue.body : '(No issue body provided.)';

          const filePath = path.join('worksheets', `issue-${issue.number}-worksheet.md`);
          const content = `# Issue #${issue.number}: ${issue.title}

**Repository:** \`${repoFull}\`  
**Issue URL:** [${issue.html_url}](${issue.html_url})  
**Author:** \`${issue.user?.login || 'unknown'}\`  
**State:** \`${issue.state}\`  
**Labels:** ${labels}  
**Assignees:** ${assignees}  
**Created:** ${issue.created_at}  
**Last Updated:** ${issue.updated_at}  

---

## Original Issue Description

${body}

---

## Printable Worksheet

> Use the sections below to capture the current understanding of this issue, decisions, and next steps. This page is designed to be printable.

### 1. Summary / Problem Statement

-  

### 2. Context & Background

-  

### 3. Stakeholders / Owners

- Primary owner:
- Other stakeholders:

### 4. Requirements / Acceptance Criteria

- [ ]  
- [ ]  

### 5. Constraints & Assumptions

-  

### 6. Risks / Open Questions

-  

### 7. Implementation Notes

-  

### 8. Next Actions

- [ ] Action:
  - Owner:
  - Due date:

---

*Generated automatically from GitHub Issue #${issue.number} on ${issue.updated_at}.*
`;

          fs.mkdirSync('worksheets', { recursive: true });
          fs.writeFileSync(filePath, content, 'utf8');
          console.log(`Created/Updated ${filePath}`);
          NODE

      - name: Convert markdown to PDF
        uses: BaileyJM02/markdown-to-pdf@v1.2.0
        with:
          input_path: worksheets/issue-${{ github.event.issue.number }}-worksheet.md
          output_dir: worksheets
          build_html: false

      - name: Commit PDF only
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          PDF_FILE="worksheets/issue-${ISSUE_NUMBER}-worksheet.pdf"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$PDF_FILE"
          git commit -m "Update PDF worksheet for issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push || echo "No changes pushed"

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: issue-${{ github.event.issue.number }}-worksheet-pdf
          path: worksheets/issue-${{ github.event.issue.number }}-worksheet.pdf
          retention-days: 90

      - name: Comment on issue with worksheet location
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;
            const mdPath = `worksheets/issue-${issueNumber}-worksheet.md`;
            const pdfPath = `worksheets/issue-${issueNumber}-worksheet.pdf`;
            const runId = context.runId;
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `ðŸ“„ Issue card PDF generated!\n\n- **PDF:** [\`${pdfPath}\`](https://github.com/${owner}/${repo}/blob/main/${pdfPath})\n- **Download:** [Artifact from workflow run](${artifactUrl})`
            });


