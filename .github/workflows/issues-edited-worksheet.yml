name: Issue Edited Worksheet

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Debug event details
        run: |
          echo "==================== EVENT DEBUG ===================="
          echo "Event name: $GITHUB_EVENT_NAME"
          echo "Action: ${{ github.event.action }}"
          echo "Issue: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          echo "State: ${{ github.event.issue.state }}"
          echo "===================================================="
          echo "Full event payload:"
          cat "$GITHUB_EVENT_PATH" | jq '.'
          echo "===================================================="

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Build printable worksheet markdown
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_STATE: ${{ github.event.issue.state }}
          ISSUE_CREATED_AT: ${{ github.event.issue.created_at }}
          ISSUE_UPDATED_AT: ${{ github.event.issue.updated_at }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          REPO_FULL: ${{ github.repository }}
        run: |
          mkdir -p worksheets
          FILE="worksheets/issue-${ISSUE_NUMBER}-worksheet.md"

          # Get labels as comma-separated string
          ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ', ') }}"
          if [ -z "$ISSUE_LABELS" ]; then
            ISSUE_LABELS="None"
          fi

          # Get assignees as comma-separated string
          ISSUE_ASSIGNEES="${{ join(github.event.issue.assignees.*.login, ', ') }}"
          if [ -z "$ISSUE_ASSIGNEES" ]; then
            ISSUE_ASSIGNEES="None"
          fi

          # If body is empty, give a friendly placeholder
          if [ -z "$ISSUE_BODY" ]; then
            ISSUE_BODY_TEXT="(No issue body provided.)"
          else
            ISSUE_BODY_TEXT="$ISSUE_BODY"
          fi

          cat <<'EOF_MARKER' > "$FILE"
# Issue #ISSUE_NUM_PLACEHOLDER: ISSUE_TITLE_PLACEHOLDER

**Repository:** `REPO_FULL_PLACEHOLDER`
**Issue URL:** [ISSUE_URL_PLACEHOLDER](ISSUE_URL_PLACEHOLDER)
**Author:** `ISSUE_AUTHOR_PLACEHOLDER`
**State:** `ISSUE_STATE_PLACEHOLDER`
**Labels:** ISSUE_LABELS_PLACEHOLDER
**Assignees:** ISSUE_ASSIGNEES_PLACEHOLDER
**Created:** ISSUE_CREATED_AT_PLACEHOLDER
**Last Updated:** ISSUE_UPDATED_AT_PLACEHOLDER

---

## Original Issue Description

ISSUE_BODY_TEXT_PLACEHOLDER

---

## Printable Worksheet

> Use the sections below to capture the current understanding of this issue, decisions, and next steps. This page is designed to be printable.

### 1. Summary / Problem Statement

-

### 2. Context & Background

-

### 3. Stakeholders / Owners

- Primary owner:
- Other stakeholders:

### 4. Requirements / Acceptance Criteria

- [ ]
- [ ]

### 5. Constraints & Assumptions

-

### 6. Risks / Open Questions

-

### 7. Implementation Notes

-

### 8. Next Actions

- [ ] Action:
  - Owner:
  - Due date:

---

*Generated automatically from GitHub Issue #ISSUE_NUM_PLACEHOLDER on ISSUE_UPDATED_AT_PLACEHOLDER.*
EOF_MARKER

          # Now replace all placeholders with actual values
          sed -i "s|ISSUE_NUM_PLACEHOLDER|${ISSUE_NUMBER}|g" "$FILE"
          sed -i "s|ISSUE_TITLE_PLACEHOLDER|${ISSUE_TITLE}|g" "$FILE"
          sed -i "s|REPO_FULL_PLACEHOLDER|${REPO_FULL}|g" "$FILE"
          sed -i "s|ISSUE_URL_PLACEHOLDER|${ISSUE_URL}|g" "$FILE"
          sed -i "s|ISSUE_AUTHOR_PLACEHOLDER|${ISSUE_AUTHOR}|g" "$FILE"
          sed -i "s|ISSUE_STATE_PLACEHOLDER|${ISSUE_STATE}|g" "$FILE"
          sed -i "s|ISSUE_LABELS_PLACEHOLDER|${ISSUE_LABELS}|g" "$FILE"
          sed -i "s|ISSUE_ASSIGNEES_PLACEHOLDER|${ISSUE_ASSIGNEES}|g" "$FILE"
          sed -i "s|ISSUE_CREATED_AT_PLACEHOLDER|${ISSUE_CREATED_AT}|g" "$FILE"
          sed -i "s|ISSUE_UPDATED_AT_PLACEHOLDER|${ISSUE_UPDATED_AT}|g" "$FILE"
          sed -i "s|ISSUE_BODY_TEXT_PLACEHOLDER|${ISSUE_BODY_TEXT}|g" "$FILE"

          echo "Created/Updated $FILE"

      - name: Install markdown-pdf tool
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf pandoc

      - name: Convert markdown to HTML then PDF
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          MD_FILE="worksheets/issue-${ISSUE_NUMBER}-worksheet.md"
          HTML_FILE="worksheets/issue-${ISSUE_NUMBER}-worksheet.html"
          PDF_FILE="worksheets/issue-${ISSUE_NUMBER}-worksheet.pdf"

          # First convert markdown to HTML with better styling
          pandoc "$MD_FILE" \
            -o "$HTML_FILE" \
            --standalone \
            --css=https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css \
            --metadata title="Issue #${ISSUE_NUMBER}"

          # Add some inline styles for better PDF rendering
          cat > /tmp/header.html <<'HEADER_EOF'
          <!DOCTYPE html>
          <html>
          <head>
          <meta charset="UTF-8">
          <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #24292e;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
          }
          h1 { color: #24292e; border-bottom: 1px solid #e1e4e8; padding-bottom: 0.3em; }
          h2 { border-bottom: 1px solid #e1e4e8; padding-bottom: 0.3em; }
          code { background-color: #f6f8fa; padding: 0.2em 0.4em; border-radius: 3px; }
          pre { background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow: auto; }
          blockquote { border-left: 4px solid #dfe2e5; padding-left: 16px; color: #6a737d; }
          a { color: #0366d6; text-decoration: none; }
          table { border-collapse: collapse; width: 100%; }
          th, td { border: 1px solid #dfe2e5; padding: 6px 13px; }
          @media print {
            body { margin: 0; padding: 20px; }
          }
          </style>
          </head>
          <body>
          HEADER_EOF

          # Create a styled HTML file
          cat /tmp/header.html > "$HTML_FILE"
          pandoc "$MD_FILE" -t html >> "$HTML_FILE"
          echo "</body></html>" >> "$HTML_FILE"

          # Convert HTML to PDF
          wkhtmltopdf \
            --enable-local-file-access \
            --margin-top 20mm \
            --margin-bottom 20mm \
            --margin-left 20mm \
            --margin-right 20mm \
            --print-media-type \
            "$HTML_FILE" \
            "$PDF_FILE"

          echo "Created PDF: $PDF_FILE"
          ls -lh "$PDF_FILE"

          # Clean up HTML file
          rm "$HTML_FILE"

      - name: Commit PDF only
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          PDF_FILE="worksheets/issue-${ISSUE_NUMBER}-worksheet.pdf"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$PDF_FILE"
          git commit -m "Update PDF worksheet for issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push || echo "No changes pushed"

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: issue-${{ github.event.issue.number }}-worksheet-pdf
          path: worksheets/issue-${{ github.event.issue.number }}-worksheet.pdf
          retention-days: 90

      - name: Comment on issue with PDF location
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;
            const pdfPath = `worksheets/issue-${issueNumber}-worksheet.pdf`;
            const runId = context.runId;
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `ðŸ“„ Issue card PDF generated!\n\n- **PDF:** [\`${pdfPath}\`](https://github.com/${owner}/${repo}/blob/main/${pdfPath})\n- **Download:** [Artifact from workflow run](${artifactUrl})`
            });
