name: Issue Edited Worksheet

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: write

jobs:
  build-worksheet:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Create markdown file using Python
        run: |
          python3 << 'PYTHON_EOF'
          import json
          import os

          with open(os.environ['GITHUB_EVENT_PATH']) as f:
              event = json.load(f)

          issue = event.get('issue', {})
          repo = os.environ.get('GITHUB_REPOSITORY', 'unknown/repo')

          labels = ', '.join([label['name'] for label in issue.get('labels', [])]) or 'None'
          assignees = ', '.join([user['login'] for user in issue.get('assignees', [])]) or 'None'
          body = issue.get('body', '').strip() or '(No issue body provided.)'

          os.makedirs('worksheets', exist_ok=True)

          with open(f"worksheets/issue-{issue['number']}-worksheet.md", 'w') as f:
              f.write(f"""# Issue #{issue['number']}: {issue['title']}

---

## Original Issue Description

{body}

---

## Printable Worksheet

> Use the sections below to capture the current understanding of this issue, decisions, and next steps. This page is designed to be printable.

### 1. Summary / Problem Statement

-

### 2. Context & Background

-

### 3. Stakeholders / Owners

- Primary owner:
- Other stakeholders:

### 4. Requirements / Acceptance Criteria

- [ ]
- [ ]

### 5. Constraints & Assumptions

-

### 6. Risks / Open Questions

-

### 7. Implementation Notes

-

### 8. Next Actions

- [ ] Action:
  - Owner:
  - Due date:

---

*Generated automatically from GitHub Issue #{issue['number']} on {issue['updated_at']}.*
""")
          PYTHON_EOF

      - name: Install md-to-pdf
        run: npm install -g md-to-pdf

      - name: Convert markdown to PDF
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          cd worksheets
          cat "issue-${ISSUE_NUMBER}-worksheet.md" | md-to-pdf > "issue-${ISSUE_NUMBER}-worksheet.pdf"
          cd ..

      - name: Commit PDF only
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          PDF_FILE="worksheets/issue-${ISSUE_NUMBER}-worksheet.pdf"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$PDF_FILE"
          git commit -m "Update PDF worksheet for issue #${ISSUE_NUMBER}" || echo "No changes to commit"
          git push || echo "No changes pushed"

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: issue-${{ github.event.issue.number }}-worksheet-pdf
          path: worksheets/issue-${{ github.event.issue.number }}-worksheet.pdf
          retention-days: 90

      - name: Comment on issue with PDF location
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;
            const pdfPath = `worksheets/issue-${issueNumber}-worksheet.pdf`;
            const runId = context.runId;
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `ðŸ“„ Issue card PDF generated!\n\n- **PDF:** [\`${pdfPath}\`](https://github.com/${owner}/${repo}/blob/main/${pdfPath})\n- **Download:** [Artifact from workflow run](${artifactUrl})`
            });
